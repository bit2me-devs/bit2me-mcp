name: Gitleaks Secret Scanning

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]
    schedule:
        # Run secret scanning weekly on Mondays at 01:00 UTC
        - cron: "0 1 * * 1"
    workflow_dispatch:

permissions: read-all

jobs:
    scan:
        name: Gitleaks Secret Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0 # Fetch all history for better detection

            - name: Download Gitleaks
              run: |
                  GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
                  VERSION_NUMBER=${GITLEAKS_VERSION#v}
                  wget -qO- https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${VERSION_NUMBER}_linux_x64.tar.gz | tar -xz
                  chmod +x gitleaks
                  sudo mv gitleaks /usr/local/bin/
                  gitleaks version

            - name: Run Gitleaks
              run: |
                  # Run Gitleaks detection
                  # Exit code 1 means secrets were found (workflow will fail)
                  # Exit code 0 means no secrets found (workflow passes)
                  gitleaks detect \
                    --source . \
                    --config .gitleaks.toml \
                    --verbose \
                    --redact \
                    --report-format sarif \
                    --report-path results.sarif

            - name: Upload results to GitHub Security
              if: always()
              uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
              with:
                  sarif_file: results.sarif

